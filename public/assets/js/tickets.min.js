$(document).ready(function () {
  const form = $('#ticket-create-form');

  form.on('submit', function (e) {
    e.preventDefault();

    // Validación frontend
    if (form[0].checkValidity() === false) {
      e.stopPropagation();
      form.addClass('was-validated');
      return;
    }

    $.ajax({
      url: form.attr('action'),
      method: 'POST',
      data: form.serialize(),
      success: function (response) {
        // Actualizar contador
        fetchTicketCount();

        // Mostrar modal de éxito
        showModal('¡Ticket creado!', 'Los técnicos han sido notificados.', 'success');
      },
      error: function (xhr) {
        let errorMsg = xhr.responseJSON?.message || 'Error desconocido';
        showModal('Error', errorMsg, 'error');
      }
    });
  });

  function fetchTicketCount() {
    $.get('/admin/tickets/count', function (data) {
      $('#ticket-counter').text(`${data.count} / 3 slots usados`);
    });
  }

  function showModal(title, message, type) {
    const modal = $('#ticket-modal');
    modal.find('.modal-title').text(title);
    modal.find('.modal-body').html(message);
    modal.find('.modal-header').removeClass().addClass(`modal-header bg-${type} text-white`);

    // Asegurar que el modal se muestre incluso si hay otros modales
    modal.modal('show');
  }

  // Cargar contador inicial
  fetchTicketCount();
});