// notifications.min.js
let base_url = window.location.protocol + "//" + window.location.host + "/" + window.location.pathname.split('/')[1];

class NotificationManager {
  constructor() {
    // Configuración de rutas
    this.soundBasePath = base_url + '/assets/sounds/';

    // Mapeo de sonidos por prioridad
    this.prioritySounds = {
      'alta': 'alarm.mp3',
      'media': 'alert.mp3',
      'baja': 'notify.mp3' // Este es tu sonido predeterminado
    };

    // Estado del sistema
    this.soundPlayed = false;
    this.pollingInterval = 30000; // 30 segundos
    this.lastSoundTime = 0;

    // Elementos UI
    this.notificationsContainer = $('#notifications-container')[0];
    this.notificationBadge = $('#notification-badge');
    this.notificationDropdown = $('#notification-dropdown');

    if (!this.notificationsContainer || !this.notificationBadge) {
      $('#notifications-container')
      console.error('Elementos del DOM no encontrados');
      return;
    }

    // Precargar sonidos (opcional)
    this.notificationSound = new Audio(); // Objeto genérico
    this.preloadSounds();

    this.init();
  }

  // Precarga los sonidos para mejor performance
  preloadSounds() {
    Object.values(this.prioritySounds).forEach(sound => {
      const audio = new Audio(this.soundBasePath + sound);
      audio.load();
    });
  }

  init() {
    this.checkNotifications();
    setInterval(() => this.checkNotifications(), this.pollingInterval);

    // Solicitar permisos solo al hacer clic en el ícono de campana de notificaciones
    document.getElementById('navbarDropdownNotifications').addEventListener('click', () => {
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission().then(permission => {
          console.log('Permiso:', permission);
        });
      }
    });

    // Delegación de eventos para marcar como leídas
    document.addEventListener('click', (e) => {
      const notificationItem = e.target.closest('.notification-item');
      if (notificationItem) {
        const notificationId = notificationItem.dataset.id; // Correcta definición aquí
        if (notificationId) {
          this.markAsRead([notificationId]);
        }
      }
    });
  }

  async markAsRead(notificationIds) {
    try {
      await fetch(base_url + '/admin/tickets/notifications/read', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: notificationIds })
      });
    } catch (error) {
      console.error('Error marcando como leída:', error);
    }
  }

  requestNotificationPermission() {
    if ('Notification' in window) {
      Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
          console.log('Permiso para notificaciones concedido');
        }
      });
    }
  }

  showSystemNotification(notification) {
    if ('Notification' in window && Notification.permission === 'granted') {
      const priorityIcons = {
        'alta': 'high.svg',
        'media': 'medium.svg',
        'baja': 'low.svg'
      };

      new Notification(`Ticket ${notification.priority.toUpperCase()}: ${notification.title}`, {
        body: notification.message,
        icon: `${base_url}/assets/images/icons/${priorityIcons[notification.priority.toLowerCase()] || 'low.svg'}`,
        vibrate: notification.priority === 'alta' ? [500, 200, 500] : [200, 100, 200]
      });
    }
  }

  async checkNotifications() {
    try {
      const response = await fetch(base_url + '/admin/tickets/notifications');
      if (!response.ok) throw new Error('HTTP ' + response.status);

      const notifications = await response.json();

      this.updateDropdown(notifications);
      const is_read = notifications.some(n => !n.is_read);

      notifications.forEach(notif => {
        if (is_read === false && notif.play_sound) {
          this.playSound(notif.priority || 'baja');
        }
        this.showToast(notif);
      });
    } catch (error) {
      console.error('Error verificando notificaciones:', error);
    }
  }

  updateBadge(count) {
    this.notificationBadge.text(count).toggleClass('d-none', count === 0);
  }

  playSound(priority = 'baja') {
    try {
      if (!this.soundBasePath) return;

      const soundFile = this.prioritySounds[priority] || this.prioritySounds['baja'];
      const soundPath = `${this.soundBasePath}${soundFile}`;

      // Crear nuevo elemento cada vez
      const audio = new Audio(soundPath);
      audio.volume = 0.7; // Volumen moderado
      audio.play().catch(e => {
        console.log('Reproducción automática bloqueada:', e);
        // Activar solo tras interacción
        document.addEventListener('click', () => audio.play(), { once: true });
      });
    } catch (e) {
      console.error('Error en playSound:', e);
    }
  }

  updateDropdown(notifications) {
    if (!this.notificationsContainer) return;

    let dropdownContent = '';

    // Función para obtener iconos de Bootstrap Icons
    const getNotificationIcon = (type) => {
      const icons = {
        alta: 'bi-exclamation-triangle-fill',
        media: 'bi-exclamation-circle-fill',
        baja: 'bi-info-circle-fill'
      };
      return icons[type] || 'bi-bell-fill';
    };

    // Función para colores
    const getNotificationColor = (type) => {
      const colors = { alta: 'danger', media: 'warning', baja: 'success' };
      return colors[type] || 'primary';
    };

    if (notifications.length === 0) {
      dropdownContent = `
        <li class="nav-item py-2 px-3">
            <div class="text-center text-muted small">
                No hay notificaciones nuevas
            </div>
        </li>`;
    } else {
      notifications.forEach(notif => {
        dropdownContent += `
            <li class="nav-item">
                <a class="dropdown-item notification-item d-flex align-items-center py-2" 
                   href="${notif.link || '#'}" 
                   data-id="${notif.id || ''}">
                    <div class="flex-shrink-0 me-3">
                        <div class="bg-${getNotificationColor(notif.type)} rounded-circle p-2">
                            <i class="bi ${getNotificationIcon(notif.type)}"></i>
                        </div>
                    </div>

                    <div class="w-100 flex-grow-1">
                      <div class="mb-1">${notif.title || 'Notificación'}</div>
                      <div class="text-muted small">
                        ${notif.message}
                        <div class="text-primary">${notif.time || 'Reciente'}</div>
                      </div>
                    </div>
                </a>
            </li>`;
      });
    }

    this.notificationsContainer.innerHTML = dropdownContent;

    const unread = notifications.filter(n => !n.is_read).length;
    this.updateBadge(unread); // Actualiza solo no leídas
  }

  getNotificationColor(type) {
    const colors = {
      'new_ticket': 'primary',
      'ticket_update': 'info',
      'ticket_closed': 'success',
      'assignment': 'warning'
    };
    return colors[type] || 'secondary';
  }

  getNotificationIcon(type) {
    const icons = {
      'new_ticket': 'fa-ticket-alt',
      'ticket_update': 'fa-sync-alt',
      'ticket_closed': 'fa-check-circle',
      'assignment': 'fa-user-tag'
    };
    return icons[type] || 'fa-bell';
  }

  showToast(notification) {
    Toastify({
      text: notification.message,
      duration: 5000,
      close: true,
      gravity: "top",
      position: "right",
      style: {
        background: `toast-${notification.type}`,
      },
      onClick: () => {
        window.location.href = notification.link;
      }
    }).showToast();
  }
}

// Inicializar cuando el DOM esté listo

document.addEventListener('DOMContentLoaded', () => {
  const notificationManager = new NotificationManager();
  // Solicitar permiso al cargar
  if (notificationManager.notificationsContainer) {
    notificationManager.requestNotificationPermission();
  }
});
